project_name := "liveopencart_assistant"
dist_dir     := "dist"
public_repo  := "varyagnord/liveopencart-pro-editor"

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏: Fedora + Just + Bash
set shell := ["bash", "-c"]
export CARGO_BUILD_JOBS := "32"

# –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
default:
    @just --list

# --- [ –°–ï–ö–¶–ò–Ø: –†–ê–ó–†–ê–ë–û–¢–ö–ê ] ---

# –ë—ã—Å—Ç—Ä–∞—è —Å–±–æ—Ä–∫–∞ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (dev —Ä–µ–∂–∏–º)
debug: clean compile-debug
    @echo "üõ† [DEBUG] –ì–æ—Ç–æ–≤–æ. –†–∞–∑–º–µ—Ä WASM:"
    @du -h pkg/{{project_name}}_bg.wasm

compile-debug:
    wasm-pack build --target web --dev

# --- [ –°–ï–ö–¶–ò–Ø: –°–ë–û–†–ö–ê –ò –£–ü–ê–ö–û–í–ö–ê ] ---

# –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ —Ä–µ–ª–∏–∑–∞
release: package
    @echo "üì¶ [RELEASE] –ì–æ—Ç–æ–≤–æ: {{project_name}}.zip"

package: clean bump-version compile-release optimize minify generate-readme zip-only

clean:
    @echo "üßπ –û—á–∏—Å—Ç–∫–∞..."
    rm -rf pkg/ target/ {{dist_dir}} *.zip /tmp/editor_version.txt /tmp/commit_msg.txt

# –ü–æ–≤—ã—à–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏. –ß–∏—Å—Ç—ã–π jq –±–µ–∑ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö echo.
bump-version:
    @echo "üî¢ –ü–æ–≤—ã—à–∞—é –≤–µ—Ä—Å–∏—é –≤ manifest.json..."
    @# –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∞–π–ª –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –¥—Ä—É–≥–∏—Ö –∫–æ–º–∞–Ω–¥
    @NEW_V=$$(jq -r '.version | split(".") | .[-1] |= (tonumber + 1 | tostring) | join(".")' manifest.json); \
    jq ".version = \"$$NEW_V\"" manifest.json > manifest.json.tmp && mv manifest.json.tmp manifest.json; \
    echo "$$NEW_V" > /tmp/editor_version.txt; \
    echo "‚úÖ –í–µ—Ä—Å–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ: $$NEW_V"

compile-release:
    wasm-pack build --target web --release

optimize:
    wasm-opt -Oz --enable-bulk-memory pkg/{{project_name}}_bg.wasm -o pkg/{{project_name}}_bg.wasm

minify:
    mkdir -p {{dist_dir}}/pkg {{dist_dir}}/assets
    cp manifest.json icon.png background.js blocker.js {{dist_dir}}/
    cp assets/* {{dist_dir}}/assets/
    terser content.js --compress drop_console=true --mangle --comments false -o {{dist_dir}}/content.js
    terser pkg/{{project_name}}.js --compress --mangle --comments false -o {{dist_dir}}/pkg/{{project_name}}.js
    cp pkg/{{project_name}}_bg.wasm {{dist_dir}}/pkg/

generate-readme:
    @V=$$(cat /tmp/editor_version.txt); \
    echo -e "# üöÄ LiveOpenCart Pro Editor\n\n–í–µ—Ä—Å–∏—è: v$$V\n\n## ‚ú® –§–∏—à–∫–∏\n- ü§ñ **AI Assistant**\n- ‚ùù **Smart Quote**\n- üé® **Syntax Highlighting**" > {{dist_dir}}/README.md

zip-only:
    cd {{dist_dir}} && zip -r ../{{project_name}}.zip . > /dev/null

# --- [ –ü–£–ë–õ–ò–ö–ê–¶–ò–Ø ] ---

# –°–±–æ—Ä–∫–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ GitHub (Bypass Secrets Mode)
publish: release
    @echo "üöÄ –ü—É–±–ª–∏–∫–∞—Ü–∏—è –Ω–∞ GitHub..."; \
    V_TAG="v$$(cat /tmp/editor_version.txt)"; \
    git log -1 --pretty=%B > /tmp/commit_msg.txt; \
    echo "üì¶ –†–µ–ª–∏–∑: $$V_TAG"; \
    rm -rf /tmp/publish_repo; \
    git clone https://github.com/{{public_repo}}.git /tmp/publish_repo; \
    cp -r {{dist_dir}}/* /tmp/publish_repo/; \
    cp {{project_name}}.zip /tmp/publish_repo/; \
    cd /tmp/publish_repo && { \
        git add .; \
        git commit -m "Auto-build: $$V_TAG" || echo "–ò–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç"; \
        git push -o push_options.bypass_secrets=true origin main; \
    }; \
    echo "üéÅ –°–æ–∑–¥–∞—é —Ä–µ–ª–∏–∑ $$V_TAG –Ω–∞ GitHub..."; \
    gh release create "$$V_TAG" {{project_name}}.zip \
        --repo {{public_repo}} \
        --title "Release $$V_TAG" \
        --notes-file /tmp/commit_msg.txt || echo "‚ö†Ô∏è –†–µ–ª–∏–∑ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"; \
    rm -f /tmp/editor_version.txt /tmp/commit_msg.txt; \
    echo "üéâ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!"